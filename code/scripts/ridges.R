# Loading Rdata file
load(paste0(paste0(rname,"/export_data/data.Rdata")))

# Function for processing an activity on a minute-by-minute basis; active = 1, not active = 0
compute_day_curve <- function(df_row) {
  start <- as.numeric(activity_time[df_row, "start_time"])
  end <- as.numeric(activity_time[df_row, "end_time"])
  wday <- as.character(activity_time[df_row, "wday"])
  
  result <- data.frame(time = seq(as.POSIXct("00:00:00", format = "%H:%M:%S"),
                                  as.POSIXct("23:59:58", format = "%H:%M:%S"),
                                  by = 60
  )) %>%
    mutate(
      time_end = lead(time, default = as.POSIXct("23:59:59", format = "%H:%M:%S")),
      active = ifelse(time > start & time_end < end, 1, 0), wday = wday
    )
  
  result
}

activity_time <- data %>%
  group_by(id) %>%
  summarise(start = min(time), end = max(time)) %>%
  mutate(
    start_time = as.POSIXct(strftime(start, format = "%H:%M:%S"), format = "%H:%M:%S"),
    end_time = as.POSIXct(strftime(end, format = "%H:%M:%S"), format = "%H:%M:%S"),
    duration = end_time - start_time,
    wday = lubridate::wday(start, week_start = 1)
  )

# Process all activities
plot_data <- 1:nrow(activity_time) %>%
  purrr::map_df(~ compute_day_curve(.x), .id = "id") %>%
  filter(!is.na(active), active > 0) %>%
  mutate(wday = as.factor(wday))

plot_data$wday <- factor(plot_data$wday, levels = rev(levels(plot_data$wday)))

# Create plot
capitalize <- function(x) {
  x <- strsplit(x, " ")
  for (i in seq(along = x)) {
    substr(x[[i]], 1, 1) <- toupper(substr(x[[i]], 1, 1))
  }
  sapply(x, function(z) paste(z, collapse = " "))
}

rname_new <- capitalize(gsub("_"," ",rname)) 

p <- ggplot() +
  ggridges::geom_density_ridges(aes(x = time, y = wday), plot_data, size = 0.5) +
  ggridges::theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0), labels = c("Sun", "Sat", "Fri", "Thu", "Wed", "Tue", "Mon")) +
  scale_x_datetime(expand = c(0, 0), date_labels = "%I:%M %p") +
  theme(panel.grid = element_blank(), plot.margin = unit(rep(1, 4), "cm")) +
  xlab(NULL) +
  ylab(NULL) +
  labs(title = paste0(rname_new,": Daily ridges"),
       subtitle = "Data sources: Strava") 

ggsave(plot = p, 
       width = 210,
       height = 210,  
       unit = "mm", 
       dpi = 400, 
       filename = paste0("/Users/laz/Library/Mobile Documents/com~apple~CloudDocs/Projects/strava/data/friends/",rname,"/plots/ridges.png"))

